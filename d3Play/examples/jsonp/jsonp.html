<!DOCTYPE html>
<html lang="en">
<head>
    <title>JSONP</title>
    <meta charset="UTF-8"/>
    <script language="JavaScript" type="text/javascript"
            src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../../css/barchart.css"/>
    <script src="../../lib/js/d3.js"></script>
</head>
<body>
<svg id="visualisation" width="1000" height="500"></svg>
<script>
    "use strict";

    function get_type(thing) {
        if (thing === null)return "[object Null]"; // special case
        return Object.prototype.toString.call(thing);
    }

    function getNo(index, val, callback) {
        var $ret = 0;
        /*
         $('body').showLoading();
         $.ajax({
         type: 'POST',
         url: BASE_URL + 'tools/no.php?id=' + index + '&value=' + val,
         data: $("#form").serialize(),
         cache: false,
         success: function (data) {
         $('body').hideLoading();
         callback(data);
         }
         });*/

        $(document).ready(function () {

            jQuery.ajax({
                type: 'GET',
                url: "http://localhost:12321/", //home
//            url: "http://lion.cs.colostate.edu:12321/", //school
                dataType: 'jsonp',
                jsonpCallback: 'geolens', // for caching
                cache: true
            }).done(function (data) {
                var message;
//            alert('success' + data[0].data);
                var barData = data[0].data;//
                callback(barData)
//            alert(get_type(data[0].message));
            }).fail(function () {
                alert('Uh Oh!');
            });

        });//end document.ready
        return $ret;
    }

    //USAGE
    getNo(3, "value", function (data) {
        //do something with data responded from the server
        //javascript replace all.
        var res = data.split('\'').join('"');
        alert(res);
        var barData = JSON.parse("[" + res + "]");
        alert(get_type(barData));
        var vis = d3.select('#visualisation'),
                WIDTH = 1000,
                HEIGHT = 500,
                MARGINS = {
                    top: 20,
                    right: 20,
                    bottom: 20,
                    left: 50
                },
                xRange = d3.scale.ordinal().rangeRoundBands([MARGINS.left, WIDTH - MARGINS.right], 0.1).domain(barData.map(function (d) {
                    return d.x;
                })),


                yRange = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([0,
                    d3.max(barData, function (d) {
                        return d.y;
                    })
                ]),

                xAxis = d3.svg.axis()
                        .scale(xRange)
                        .tickSize(5)
                        .tickSubdivide(true),

                yAxis = d3.svg.axis()
                        .scale(yRange)
                        .tickSize(5)
                        .orient("left")
                        .tickSubdivide(true);


        vis.append('svg:g')
                .attr('class', 'x axis')
                .attr('transform', 'translate(0,' + (HEIGHT - MARGINS.bottom) + ')')
                .call(xAxis);

        vis.append('svg:g')
                .attr('class', 'y axis')
                .attr('transform', 'translate(' + (MARGINS.left) + ',0)')
                .call(yAxis);

        vis.selectAll('rect')
                .data(barData)
                .enter()
                .append('rect')
                .attr('x', function (d) {
                    return xRange(d.x);
                })
                .attr('y', function (d) {
                    return yRange(d.y);
                })
                .attr('width', xRange.rangeBand())
                .attr('height', function (d) {
                    return ((HEIGHT - MARGINS.bottom) - yRange(d.y));
                })
                .attr('fill', 'grey')
                .on('mouseover', function (d) {
                    d3.select(this)
                            .attr('fill', 'blue');
                })
                .on('mouseout', function (d) {
                    d3.select(this)
                            .attr('fill', 'grey');
                });
    });

</script>
</body>
</html>